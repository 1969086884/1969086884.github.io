

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="sw0rd1ight">
  <meta name="keywords" content="代码审计">
  <meta name="description" content="博客备份，本文翻译原文地址为 https:&#x2F;&#x2F;blog.assetnote.io&#x2F;2023&#x2F;04&#x2F;26&#x2F;xss-million-websites-cpanel&#x2F;  cPanel 是一款控制面板软件，在互联网上广泛使用。确切地说，在写这篇博客文章的时候，大约有140万个cPanel 安装在外部互联网上。我们发现了一个反射型XSS漏洞，可以在没有任何身份验证的情况下被利用。除此之外，无论 c">
<meta property="og:type" content="article">
<meta property="og:title" content="译文:在一百万个网站中发现 XSS (cPanel CVE-2023-29489)">
<meta property="og:url" content="https://sw0rd1ight.github.io/2023/07/30/%E8%AF%91%E6%96%87-%E5%9C%A8%E4%B8%80%E7%99%BE%E4%B8%87%E4%B8%AA%E7%BD%91%E7%AB%99%E4%B8%AD%E5%8F%91%E7%8E%B0-XSS-cPanel-CVE-2023-29489/index.html">
<meta property="og:site_name" content="sw0rd1ight&#39;s Blog">
<meta property="og:description" content="博客备份，本文翻译原文地址为 https:&#x2F;&#x2F;blog.assetnote.io&#x2F;2023&#x2F;04&#x2F;26&#x2F;xss-million-websites-cpanel&#x2F;  cPanel 是一款控制面板软件，在互联网上广泛使用。确切地说，在写这篇博客文章的时候，大约有140万个cPanel 安装在外部互联网上。我们发现了一个反射型XSS漏洞，可以在没有任何身份验证的情况下被利用。除此之外，无论 c">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/22550391/1687495472229-abb5f687-3181-4aa5-b0f9-09731466822f.png#averageHue=%23fcfcfb&clientId=u7b3fc323-f4db-4&from=paste&height=422&id=u1fec1d14&originHeight=844&originWidth=3180&originalType=binary&ratio=1.7999999523162842&rotation=0&showTitle=false&size=189851&status=done&style=none&taskId=ude343233-a326-44e7-b19e-f0e4e76d1cd&title=&width=1590">
<meta property="article:published_time" content="2023-07-30T02:27:08.000Z">
<meta property="article:modified_time" content="2023-07-30T02:35:53.817Z">
<meta property="article:author" content="sw0rd1ight">
<meta property="article:tag" content="cPanel">
<meta property="article:tag" content="XSS">
<meta property="article:tag" content="CVE-2023-29489">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://cdn.nlark.com/yuque/0/2023/png/22550391/1687495472229-abb5f687-3181-4aa5-b0f9-09731466822f.png#averageHue=%23fcfcfb&clientId=u7b3fc323-f4db-4&from=paste&height=422&id=u1fec1d14&originHeight=844&originWidth=3180&originalType=binary&ratio=1.7999999523162842&rotation=0&showTitle=false&size=189851&status=done&style=none&taskId=ude343233-a326-44e7-b19e-f0e4e76d1cd&title=&width=1590">
  
  <title>译文:在一百万个网站中发现 XSS (cPanel CVE-2023-29489) - sw0rd1ight&#39;s Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"sw0rd1ight.github.io","root":"/","version":"1.8.11","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname"}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>sw0rd1ight&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('https://rmt.ladydaily.com/fetch/fluid/storage/bg/vdysjx.png?w=1920&fmt=webp') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="译文:在一百万个网站中发现 XSS (cPanel CVE-2023-29489)">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2023-07-30 10:27" pubdate>
        2023年7月30日 上午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      6.9k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      22 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">译文:在一百万个网站中发现 XSS (cPanel CVE-2023-29489)</h1>
            
            <div class="markdown-body">
              <meta name="referrer" content="no-referrer">  

<blockquote>
<p>博客备份，本文翻译原文地址为 <a target="_blank" rel="noopener" href="https://blog.assetnote.io/2023/04/26/xss-million-websites-cpanel/">https://blog.assetnote.io/2023/04/26/xss-million-websites-cpanel/</a></p>
</blockquote>
<p>cPanel 是一款控制面板软件，在互联网上广泛使用。确切地说，在写这篇博客文章的时候，大约有140万个cPanel 安装在外部互联网上。<br>我们发现了一个反射型XSS漏洞，可以在没有任何身份验证的情况下被利用。除此之外，无论 cPanel 管理端口(2080,2082,2083,2086)是否暴露在外部，XSS漏洞都是可利用的。这意味着如果你的网站是由 cPanel 管理的，那么你在80和443端口的网站也容易受到此跨站脚本漏洞的攻击。<br>对于那些担心自己的网站受到这个漏洞影响的人，也不要担心，因为互联网上很多 cPanel 在安装时都启用了 cPanel 的自动更新功能，这意味着可能不再容易受到攻击。如果没有设置这个特性，请阅读这个链接<a target="_blank" rel="noopener" href="https://support.cpanel.net/hc/en-us/articles/360053076314-How-to-re-enable-automatic-updates">https://support.cpanel.net/hc/en-us/articles/360053076314-How-to-re-enable-automatic-updates</a>，了解如何启用它。<br>也可以在<a target="_blank" rel="noopener" href="https://forums.cpanel.net/threads/cpanel-tsr-2023-0001-full-disclosure.708949/">https://forums.cpanel.net/threads/cpanel-tsr-2023-0001-full-disclosure.708949/</a>阅读 cPanel官方对于此xss漏洞的处置建议。</p>
<h3 id="熟悉cPanel代码"><a href="#熟悉cPanel代码" class="headerlink" title="熟悉cPanel代码"></a>熟悉cPanel代码</h3><p>cPanel 和我在这个世界上存在的时间一样长(设计于1996年) ，只有27年多一点。这可能是我们审计过的最古老的软件之一。<br>cPanel 的历史就意味着它所利用的许多范式和技术并不一定是现代的。大多数 cPanel功能都是用 Perl 编写的，其中有一些是用 Perl 编译成的二进制文件。<br>我们去年年中开始研究 cPanel 时，我们主要关注的是可以在 cPanel 管理口<code>/cgi-sys/</code>目录下可以访问的二进制文件。这些二进制文件由Perl代码编译而成，可以通过 HTTP 请求进行远程调用。理解这些二进制文件的逻辑是困难的。虽然我们找到了几种可以利用的途径，但是我们发现内置的缓解方法阻碍了我们成功地利用这些潜在的问题。<br>除了这个目录中的这些二进制文件之外，我们还注意到 cPanel 的核心功能和 Web 应用程序是通过<strong>cpsrvd</strong>二进制文件提供服务的。这个二进制文件监听以下端口:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@vm:~<span class="hljs-comment"># lsof -Pi | grep cpsrvd</span><br>cpsrvd    43328     root    3u  IPv4 218993      0t0  TCP *:2082 (LISTEN)<br>cpsrvd    43328     root    4u  IPv4 218994      0t0  TCP *:2086 (LISTEN)<br>cpsrvd    43328     root    5u  IPv4 218995      0t0  TCP *:2083 (LISTEN)<br>cpsrvd    43328     root    6u  IPv4 218996      0t0  TCP *:2087 (LISTEN)<br></code></pre></td></tr></table></figure>
<p>cPanel 使用了Apache http的反向代理功能，其配置文件位置为<code>/etc/apache2/conf/httpd.conf</code>。这个文件为我们提供了很多线索和上下文。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">ProxyPass /cpanelwebcall/ http://127.0.0.1:2082/cpanelwebcall/ max=1 retry=0<br><br>... omitted <span class="hljs-keyword">for</span> brevity ...<br><br>ScriptAlias /.cpanel/dcv /usr/<span class="hljs-built_in">local</span>/cpanel/cgi-priv/get_local.cgi<br><br>RewriteEngine On<br><br>RewriteCond %&#123;REQUEST_URI&#125; ^/\.well-known/acme-challenge/[0-9a-zA-Z_-]+$ [OR]<br>RewriteCond %&#123;REQUEST_URI&#125; ^/\.well-known/cpanel-dcv/[0-9a-zA-Z_-]+$ [OR]<br>RewriteCond %&#123;REQUEST_URI&#125; ^/\.well-known/pki-validation/[A-F0-9]&#123;32&#125;\.txt(?:\ Sectigo\ DCV)?$ [OR]<br>RewriteCond %&#123;REQUEST_URI&#125; ^/\.well-known/pki-validation/(?:\ Ballot169)?<br>RewriteRule ^ /.cpanel/dcv [passthrough]<br></code></pre></td></tr></table></figure>
<p>以上只是 httpd.conf 文件的一小部分摘录。如果您正在考虑审计 cPanel，我们建议从这个文件中的所有不同代理规则开始。<br>值得庆幸的是，cPanel 确实附带了大量源代码，当你安装好cPanel之后，就可以在<code>/usr/local/cpanel/</code>路径获取大量源码。虽然这也是大多数二进制文件存在的地方，但是仍然可以通过从这个目录中存在的 perl 代码来理解cPanel的一些逻辑。<br>尽管该文件夹中的perl代码包含了大量关于路由如何工作的线索，但是真相的来源仍然是cpsrvd二进制文件，它似乎是所有Perl代码的编译版本。在<code>/usr/local/cpanel</code>目录中找到的源代码看起来并不包含cPanel提供的所有完整功能。尽管如此，我们还是很感激这一点，因为它为我们提供了足够的信息来发现XSS漏洞。</p>
<h3 id="解构Httpd-pm"><a href="#解构Httpd-pm" class="headerlink" title="解构Httpd.pm"></a>解构Httpd.pm</h3><p>在试图理解cPanel的路由时，我们注意到了<code>Cpanel/Server/Handlers/Httpd.pm</code>，其中包含对某些路径具体的处理。这种逻辑使我们能够在不必理解二进制文件的情况下，了解到一个功能和路由的关系。<br>文件顶部的注释给了一个很好的概述:</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-comment">=head1 DESCRIPTION</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">This module implements a tiny HTTP server in cpsrvd that executes a</span><br><span class="hljs-comment">whitelist of functionality.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">This is useful for contexts where no other service is running on the standard</span><br><span class="hljs-comment">HTTP and HTTPS ports.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">It implements the following behaviors:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">=over</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">=item * Any request whose path is under F&lt;/.well-known&gt; is served as a</span><br><span class="hljs-comment">static file. The path on disk that’s loaded is the same as under Apache.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">=item * Any other request whose C&lt;Host&gt; header starts with one of the</span><br><span class="hljs-comment">following is served as appropriate: C&lt;cpcalendars.&gt;, C&lt;cpcontacts.&gt;,</span><br><span class="hljs-comment">C&lt;autodiscover.&gt;, C&lt;autoconfig.&gt;. The latter two are only served if</span><br><span class="hljs-comment">they are enabled in the server configuration.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Note that C&lt;cpanel.&gt;, C&lt;whm.&gt;, and C&lt;webmail.&gt; are NOT handled here.</span><br><span class="hljs-comment">This is largely because the relevant applications are under base cpsrvd</span><br><span class="hljs-comment">and thus not (readily) callable from this module, so we have to handle</span><br><span class="hljs-comment">those applications separately.</span><br></code></pre></td></tr></table></figure>
<p>在这个 Perl 代码中可以找到以下功能:</p>
<ul>
<li>基于特定服务处理当前域和子域的路由（Handling subdomain/hostname based routing to certain services）<ul>
<li>cpcalendars =&gt; ‘proxy_cpcalendars_cpcontacts’</li>
<li>cpcontacts =&gt; ‘proxy_cpcalendars_cpcontacts’</li>
<li>autodiscover =&gt; ‘autodiscover’</li>
<li>autoconfig =&gt; ‘autoconfig’</li>
</ul>
</li>
<li>处理静态文件（Handling static paths）<ul>
<li>/img-sys/</li>
<li>/sys_cpanel/</li>
</ul>
</li>
<li>针对cpanel, whm, webmail进行重定向(Handling redirects for /cpanel, /whm, /webmail)</li>
<li>处理BoxTrapper相关请求（Handling <a target="_blank" rel="noopener" href="https://docs.cpanel.net/cpanel/email/boxtrapper/">BoxTrapper</a> requests /cgi-sys/bxd.cgi）</li>
<li>调用/cpanelwebcall/处理动态DNS相关功能（Handling Dynamic DNS related functionality, specifically calls to /cpanelwebcall/）</li>
</ul>
<p>除了 Httpd.pm，我们还在处理 websocket 消息的<code>Cpanel/Server/Handlers/comet.pm</code>上花费了大量时间。其中有很多有趣的功能，似乎可以导致任意的文件写入，但在我们分配给 cPanel 研究的时间里，我们没能找到一个具有任何有意义的sink。</p>
<h3 id="寻找XSS"><a href="#寻找XSS" class="headerlink" title="寻找XSS"></a>寻找XSS</h3><p>在 Httpd.pm 中，我们可以看到以下代码片段:</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-keyword">elsif</span> ( <span class="hljs-number">0</span> == <span class="hljs-keyword">rindex</span>( $doc_path, <span class="hljs-string">&#x27;/cpanelwebcall/&#x27;</span>, <span class="hljs-number">0</span> ) ) &#123;<br><br>        <span class="hljs-comment"># First 15 chars are “/cpanelwebcall/”</span><br>        _serve_cpanelwebcall(<br>            $self-&gt;get_server_obj(),<br>            <span class="hljs-keyword">substr</span>( $doc_path, <span class="hljs-number">15</span> ),<br>        );<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>这意味着以<code>/cpanelwebcall/</code>开头的任何路径都将被路由到<code> _service_cpanelwebcall</code><br><code>_service_cpanelwebcall</code>函数实现如下所示:</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-function"><span class="hljs-keyword">sub</span> _<span class="hljs-title">serve_cpanelwebcall</span> ( $<span class="hljs-title">server_obj</span>, $<span class="hljs-title">webcall_uri_piece</span> ) </span>&#123;<br>    <span class="hljs-keyword">require</span> Cpanel::Server::WebCalls;<br>    <span class="hljs-keyword">my</span> $out = Cpanel::Server::WebCalls::handle($webcall_uri_piece);<br><br>    $server_obj-&gt;respond_200_ok_text($out);<br><br>    <span class="hljs-keyword">return</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>其中调用了<code>Cpanel::Server::WebCalls::handle</code>，其实现如下</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-function"><span class="hljs-keyword">sub</span> <span class="hljs-title">handle</span> ($<span class="hljs-title">request</span>) </span>&#123;<br><br>    <span class="hljs-keyword">my</span> $id = extract_id_from_request($request);<br>    <span class="hljs-keyword">substr</span>( $request, <span class="hljs-number">0</span>, <span class="hljs-keyword">length</span> $id ) = <span class="hljs-string">q&lt;&gt;</span>;<br><br>    Cpanel::WebCalls::ID::is_valid($id) <span class="hljs-keyword">or</span> <span class="hljs-keyword">do</span> &#123;<br>        <span class="hljs-keyword">die</span> _http_invalid_params_err(<span class="hljs-string">&quot;Invalid webcall ID: $id&quot;</span>);<br>    &#125;;<br></code></pre></td></tr></table></figure>
<p>Handle中又调用了<code>_http_invalid_params_err</code></p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-function"><span class="hljs-keyword">sub</span> _<span class="hljs-title">http_invalid_params_err</span> ($<span class="hljs-title">why</span>) </span>&#123;<br>    <span class="hljs-keyword">return</span> Cpanel::Exception::create_raw( <span class="hljs-string">&#x27;cpsrvd::BadRequest&#x27;</span>, $why );<br>&#125;<br></code></pre></td></tr></table></figure>
<p>从其中的包名<code>cpsrvd::BadRequest</code>，我们可以追溯到<code>Cpanel/Exception/cpsrvd/BadRequest.pm</code>。这就是线索断绝的地方。尽管我们有很多可用的 Perl 源代码，但是由于没看到对<code>Httpd::ErrorPage</code> 的调用，无法对整个链进行端到端的跟踪。<br>我们经过实践发现，sink在<code>Cpanel::Server::Handlers::Httpd::ErrorPage</code> 。但是我们无法找到初始化这个 Perl 代码的位置。我们怀疑这是嵌入在 cPanel 二进制文件中的，因此我们无法确定这段代码被调用的位置。<br>深入研究<code>Httpd::ErrorPage</code>代码，我们可以看到它接受了一个名为<code>message_html</code>的变量，该变量是此漏洞的sink，因为该变量没有经过任何的过滤。</p>
<p>查看 cPanel 最新版本的补丁，我们可以看到在<code> Cpanel/Server/Handlers/Httpd/ErrorPage.pm</code>中添加了以下两行:</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs perl">++ <span class="hljs-keyword">use</span> Cpanel::Encoder::Tiny               ();	<br><br>... omitted <span class="hljs-keyword">for</span> brevity ...<br><br>++ $var<span class="hljs-string">&#123;message_html&#125;</span> = Cpanel::Encoder::Tiny::safe_html_encode_str( $var<span class="hljs-string">&#123;message_html&#125;</span> );<br></code></pre></td></tr></table></figure>
<h3 id="POC-Proof-of-Concept"><a href="#POC-Proof-of-Concept" class="headerlink" title="POC(Proof of Concept)"></a>POC(Proof of Concept)</h3><p>把我们上面发现到的所有东西放在一起，我们就可以得到一个XSS漏洞的POC，比如下面这个:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">http://example.com/cpanelwebcall/&lt;img%20src=x%20onerror=<span class="hljs-string">&quot;prompt(1)&quot;</span>&gt;aaaaaaaaaaaa<br>http://example.com:2082/cpanelwebcall/&lt;img%20src=x%20onerror=<span class="hljs-string">&quot;prompt(1)&quot;</span>&gt;aaaaaaaaaaaa<br>http://example.com:2086/cpanelwebcall/&lt;img%20src=x%20onerror=<span class="hljs-string">&quot;prompt(1)&quot;</span>&gt;aaaaaaaaaaaa<br>http://example.com:2082/cpanelwebcall/&lt;img%20src=x%20onerror=<span class="hljs-string">&quot;prompt(1)&quot;</span>&gt;aaaaaaaaaaaa<br><br>... potentially other ports ...<br></code></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2023/png/22550391/1687495472229-abb5f687-3181-4aa5-b0f9-09731466822f.png#averageHue=%23fcfcfb&clientId=u7b3fc323-f4db-4&from=paste&height=422&id=u1fec1d14&originHeight=844&originWidth=3180&originalType=binary&ratio=1.7999999523162842&rotation=0&showTitle=false&size=189851&status=done&style=none&taskId=ude343233-a326-44e7-b19e-f0e4e76d1cd&title=&width=1590" srcset="/img/loading.gif" lazyload alt="image.png"></p>
<h3 id="影响"><a href="#影响" class="headerlink" title="影响"></a>影响</h3><p>这个漏洞的影响是，我们能够在默认配置的 cPanel 中的几乎每个 web 服务器端口上执行任意的 JavaScript。<br>这是因为前面提到的代理规则的缘故。即使在80和443端口上，我们也能够访问<code>/cpanelwebcall/</code>目录，因为它正被 Apache 代理到cPanel管理端口。<br>因此 攻击者不仅可以攻击 cPanel 的管理端口，还可以攻击运行在80和443端口上的应用程序。<br>由于cPanel管理端口容易受到这种跨网站脚本攻击，攻击者可以利用这种漏洞劫持合法用户的 cPanel 会话。</p>
<h3 id="缓解措施和时间线"><a href="#缓解措施和时间线" class="headerlink" title="缓解措施和时间线"></a>缓解措施和时间线</h3><p>上述xss漏洞可以通过升级到以下任何 cPanel 版本或更高版本来缓解:</p>
<ul>
<li>11.109.9999.116</li>
<li>11.108.0.13</li>
<li>11.106.0.18</li>
<li>11.102.0.31</li>
</ul>
<p>披露的时间线如下:</p>
<ul>
<li>2023年1月23日: 通过 <a href="mailto:&#115;&#101;&#99;&#117;&#114;&#105;&#x74;&#121;&#64;&#x63;&#80;&#97;&#110;&#x65;&#108;&#46;&#110;&#101;&#x74;">&#115;&#101;&#99;&#117;&#114;&#105;&#x74;&#121;&#64;&#x63;&#80;&#97;&#110;&#x65;&#108;&#46;&#110;&#101;&#x74;</a> 向 cPanel 披露 XSS 漏洞。</li>
<li>2023年1月23日: cPanel 证实他们收到了漏洞并正在进一步调查。</li>
<li>2023年2月13日: 漏洞已被 cPanel 确认并分配给 SEC-669。几周后将发布针对性的安全修复程序。</li>
<li>2023年3月1日: 漏洞固定和公开披露在 cPanel 网站上发布。</li>
</ul>
<p>cPanel团队在我们向他们披露这个漏洞后，能够在合理的时间内处理和修复这个问题。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>CPanel 具有巨大的攻击面，需要安全研究人员社区给予更多的关注。在我们研究 cPanel 的过程中，最大的阻碍之一是编译成 Perl 的二进制文件。我们相信在这些二进制文件中还有更严重的 bug 有待发现，尽管从逆向工程的角度来看，处理它们是相当痛苦的。<br>我们对 cpsrvd 二进制文件的分析发现，大多数端点在身份验证之前都无法访问，然而/cgi-sys/目录中有大量的二进制文件可能需要更多的关注。<br>这是我们第一次向软件供应商报告一个 bug，这个供应商的软件cPanel有自动更新功能，仅这一缓解措施就保护了大多数 cPanel 网站免受在野攻击。<br>尽管如此，仍然有可能发现大量的 cPanel 网站仍然容易受到攻击，因为它们没有启用自动更新功能。</p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a target="_blank" rel="noopener" href="https://blog.assetnote.io/2023/04/26/xss-million-websites-cpanel/">https://blog.assetnote.io/2023/04/26/xss-million-websites-cpanel/</a></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E5%AE%89%E5%85%A8/">安全</a>
                    
                      <a class="hover-with-bg" href="/categories/%E5%AE%89%E5%85%A8/%E7%BF%BB%E8%AF%91/">翻译</a>
                    
                      <a class="hover-with-bg" href="/categories/%E5%AE%89%E5%85%A8/%E7%BF%BB%E8%AF%91/CVE/">CVE</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/cPanel/">cPanel</a>
                    
                      <a class="hover-with-bg" href="/tags/XSS/">XSS</a>
                    
                      <a class="hover-with-bg" href="/tags/CVE-2023-29489/">CVE-2023-29489</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/02/19/%E5%90%91%E6%97%A5%E8%91%B5%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88CNVD-2022-10270%EF%BC%89%E5%A4%8D%E7%8E%B0/">
                        <span class="hidden-mobile">向日葵远程代码执行漏洞（CNVD-2022-10270）复现</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
